<!DOCTYPE html>
<head>
  <title>week1</title>
  <style type="text/css">
    #gameBox {
      display: flex;
      width: 70vw;
      flex-wrap: wrap;
    }
    .piece {
      background: wheat;
      border: 1px solid black;
      width: 20vw;
      flex: 0 0 20vw;
      height: 20vw;
      font-size: 16vw;
      text-align: center;
      line-height: 20vw;
    }
  </style>
</head>
<body>
  <div id="gameBox">

  </div>
  <div class="infomation">

  </div>
  <script>
    // const Pieces = Object.freeze({
    //   Blank: '',
    //   Circle: '⭕',
    //   Cross: '❌'
    // })
    const Pieces = {}
    Pieces[Pieces['Blank'] = 0] = '';
    Pieces[Pieces['Circle'] = 1] = '⭕';
    Pieces[Pieces['Cross'] = 2] = '❌';
    const ROWMAX = 3;
    const COLMAX = 3;
    const BOARDSIZE = ROWMAX * COLMAX;
    function Game() {
      this._active = Pieces.Circle; // 当前落子
    }
    Game.prototype.draw = function() {
      if (!this.pattern) {
        this.pattern = []
        for (let row = 0; row < ROWMAX; row++) {
          for(let col = 0; col < COLMAX; col++) {
            this.pattern[rowCol2index(row, col)] = Pieces[Pieces.Blank]
          }
        }
      }
      if (!this.gameBox || !this.gameBox.parentElement) {
        let gameBox = document.getElementById('gameBox')
        this._pieceDivs = []
        this.gameBox = gameBox
        gameBox.innerHTML = ''
        for (let i = 0; i < BOARDSIZE; i++) {
          let pieceDiv = document.createElement('div')
          pieceDiv.className = 'piece'
          this._pieceDivs[i] = pieceDiv;
          pieceDiv.addEventListener('click', () => {
            if (this.hasWin) {
              return;
            }
            const innerHTML = pieceDiv.innerHTML;
            if (innerHTML) {
              return;
            }
            this.pattern[i] = this._active
            pieceDiv.innerHTML = Pieces[this._active]
            let isWin = checkWin(this.pattern)
            if (isWin) {
              this.hasWin = true;
              console.error(Pieces[isWin] + ' win')
              return
            }
            this._active = 3 - this._active
          })
          gameBox.appendChild(pieceDiv)
        }
      }
      for (let i = 0; i < BOARDSIZE; i++) {
        this._pieceDivs[i].innerHTML = this.pattern[i]
      }
    }
    function rowCol2index(row, col) {
      return row * COLMAX + col
    }
    function index2row(index) {
      return index / COLMAX >> 0
    }
    function index2col(index) {
      return index % COLMAX
    }
    function index3rowCol(index) {
      return [index2row(index), index2col(index)]
    }
    /**
     * 如果获胜，返回获胜的一方值
     * */
    function checkWin(pattern) {
      for (let row = 0; row < ROWMAX; row++) {
        let startI = row * COLMAX;
        // 只支持 COLMAX 等于 3 的情况
        if (pattern[startI] == pattern[startI + 1] && pattern[startI] == pattern[startI + 2]) {
          if (pattern[startI]) {
            return pattern[startI];
          }
        }
      }
      // 竖列
      for (let col = 0; col < COLMAX; col++) {
        if (pattern[col] == pattern[COLMAX + col] && pattern[col] == pattern[COLMAX * 2 + col]) {
          if (pattern[col]) {
            return pattern[col];
          }
        }
      }
      let midValue = pattern[COLMAX + 1];
      if (midValue && midValue == pattern[COLMAX * 2 + 2] && midValue == pattern[0]) {
        return midValue
      }
      if (midValue && midValue == pattern[2] && midValue == pattern[COLMAX * 2]) {
        return midValue
      }
    }
    let gameIns = new Game()
    gameIns.draw()
  </script>
  <script>
    
  </script>
</body>