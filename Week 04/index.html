<!DOCTYPE html>
<html>
  <head>
    <title>字符串匹配算法</title>
    <style type="text/css">
      .df {
        display: flex;
      }
    </style>
  </head>
  <body>
    <div id='table' class="df">

    </div>
    <hr />
    <div id="source">
    </div>
    <div id="pattern">
    </div>
    <script>

      async function kmp (source, pattern) {
        if (source.length < pattern.length) {
          // 边界条件
          return
        }

        let sourceEle = document.getElementById('source')
        sourceEle.innerHTML = source
        let patternEle = document.getElementById('pattern')
        patternEle.innerHTML = pattern
        // 建立 pattern 移动表
        // let nexts = getNexts(pattern)
        let nextor = await getNexts(pattern)
        // 查找主流程
        let j = 0;
        for (let i = 0; i < source.length; i++) {
          if (pattern[j] != source[i]) {
            while (true) {
              // j = nexts[j - 1]
              j = await nextor.get(j - 1)
              if (j > 0) {
                if (pattern[j] == source[i]) {
                  break
                } else {
                  // 没匹配上，继续往下匹配
                }
              } else {
                j = 0
                break;
              }
            }
          } else {
            // 模式串增加一位
            j++
          }

          // 判断匹配完成
          if (j === pattern.length - 1) {
            return {
              start: i - j + 1,
              end: i + 1
            };
          }
        }
        return null
      }


      const GetColor = 'red'
      async function getNexts(pattern) {
        let nexts = new Array(pattern.length).fill(0)
        let j = 0; // 模式串匹配的下标
        let i = 1;
        class Nextor {
          constructor() {
            this.nexts = nexts
            let tableEle = document.getElementById('table')
            this.tableEle = tableEle
            tableEle.innerHTML = ''
            for (let c of pattern) {
              let div = document.createElement('div')
              div.innerHTML = `
                <div>${c}</div>
                <div>${0}</div>
              `
              tableEle.appendChild(div)
            }
          }

          async get(j, isSleep) {
            let children = this.tableEle.children;
            for (let i = 0; i < children.length; i++) {
              let ele = children[i];
              children[i].style.backgroundColor = (i == j ? GetColor : '');
            }
            if (isSleep) {
              await sleep(500)
            }
            return nexts[j]
          }

          async set(i, j, isSleep) {
            nexts[i] = j
            let children = this.tableEle.children;
            children[i].style.backgroundColor = 'green'
            children[i].children[1].innerHTML = j
            if (isSleep) {
              await sleep(500)
            }
          }
        }
        let nextor = new Nextor()
        while (i < pattern.length) {
          if (pattern[i] == pattern[j]) {
            await nextor.set(i, j + 1, true)
            // nexts[i] = j + 1
            i++
            j++
          } else {
            // j = nexts[j - 1]
            j = await nextor.get(j - 1, true)
            if (!j) {
              j = 0
              i++
            }
            continue
          }
        }
        return nextor
        // return nexts
      }

      let pattern = 'afafieflaf'
      pattern = 'aabaaac';
      (async function () {
        // let nexts = await getNexts(pattern)
        // console.log(nexts)

        let source = 'cadfaabaaacwwwef'

        let result = await kmp(source, pattern)
        console.log(result)
        if (result) {
          console.log(source.slice(result.start, result.end + 1))
        }
      })()
      function sleep(timeout) {
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve()
          }, timeout);
        })
      }
    </script>
  </body>
</html>